<!-- <div class="flex gap-5">
    <button id="openModal" class="font-bold px-4 py-3 border border-gray-300 rounded-lg">Add folder</button>
    <form action="/admin/gallery/image-upload" method="post" enctype="multipart/form-data">
        <input type="file" name="image" class="px-4 py-3 border border-gray-300 rounded-lg" >
        <button type="submit" class="border border-indigo-500 px-4 py-3 rounded-lg">Submit</button>
    </form>
</div> -->
<div class="flex gap-5">
  <button id="openModal"
    class="font-bold px-4 py-3 border border-gray-300 rounded-lg">
    Add folder
  </button>

  <input type="file" id="uploadInput"
    class="px-4 py-3 border border-gray-300 rounded-lg">

  <button id="btnUpload"
    class="border border-indigo-500 px-4 py-3 rounded-lg">
    Upload
  </button>
</div>

<!-- <form action="/admin/gallery/image-upload" method="post" enctype="multipart/form-data">
    
    <select name="folder" class="px-4 py-3 border rounded-lg">
        <option value="banners">Banners</option>
        <option value="products">Products</option>
        <option value="blog">Blog</option>
        <option value="default">Default</option>
    </select>

    <input type="file" name="image" class="px-4 py-3 border rounded-lg">
    
    <button type="submit" class="border border-indigo-500 px-4 py-3 rounded-lg">
        Upload
    </button>
</form> -->

<div class="gallery_wrapper grid grid-cols-12 gap-4 mt-5" >
    <!-- folder [LEFT] -->
    <!-- CRUD Folder Section - 3 cols -->
    <div class="col-span-2">
        <!-- CRUD Folder component s·∫Ω ·ªü ƒë√¢y -->
        <div id="folder_tree" class="text-sm select-none">

    <!-- ROOT -->
    <div data-folder="all"
        class="folder-item root flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer 
               bg-indigo-50 text-indigo-700 font-semibold">
        <!-- <span>üìÅ</span> -->
                 <i class="fa-solid fa-folder-tree text-amber-500"></i>
        <span>T·∫•t c·∫£</span>
    </div>

    <!-- CHILDREN -->
    <% folders.forEach(folder => { %>
  <div data-folder="<%=folder._id%>"
    class="folder-item child flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer 
           hover:bg-gray-100 text-gray-700 relative group">

    <span class="absolute left-3 top-0 bottom-0 w-px bg-gray-200"></span>
    <span class="ml-4"></span>
    <i class="fa-solid fa-folder-open text-amber-400"></i>

    <span class="flex-1"><%=folder.name%></span>

    <!-- delete icon -->
    <i data-del="<%=folder._id%>"
      class="fa-solid fa-trash text-red-400 opacity-0 group-hover:opacity-100 
      hover:text-red-600 cursor-pointer"></i>

  </div>
<% }) %>

</div>

    </div>

    <!-- gallery grid [RIGHT]-->
<div class="col-span-10 h-dvh overflow-y-auto w-full ">
    <div id="image_container" class="grid gird-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 mt-5">
    <%if(images.length ===0){%>
        <p class="col-span-full text-center text-gray-500">Ch∆∞a c√≥ ·∫£nh n√†o</p>
    <%}else{%>
        <%images.forEach(img=>{%>
            <div class="group relative rounded-xl overflow-hidden shadow bg-white dark:bg-gray-800">
                <!-- IMAGE -->
                 <img src="/<%=img.path%>" alt="<%=img.name%>"
                 loading="lazy"
                 class="w-full h-40 object-cover transition-transform duration-300 group-hover:scale-105"
                 >
                 <!-- OVERLAY -->
        <div
          class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100
          flex items-center justify-center gap-3 transition"
        >
          <a
            href="/<%= img.path %>"
            target="_blank"
            class="px-3 py-1.5 bg-white rounded-lg text-sm font-medium hover:bg-gray-100"
          >
            View
          </a>

          <button
            data-id="<%=img.path%>"
            class="px-3 py-1.5 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600"
          >
            Delete
          </button>
        </div>
                 <!--  -->
            </div>
       <% })%>
    <%}%>
</div>
</div>

</div>

<!-- Modal -->

<!-- MODAL -->
<div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
  
  <!-- BOX -->
  <div class="bg-white rounded-xl shadow-lg w-[400px] max-w-full p-6 relative">

    <h2 class="text-lg font-bold mb-3">Folder popup</h2>
    <!-- <p class="text-gray-600">N·ªôi dung modal ·ªü ƒë√¢y</p> -->
     <div>
        <input type="text" name="foler_name" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Folder name...">
     </div>

    <!-- actions -->
    <div class="mt-6 flex justify-end gap-2">
      <button id="closeModal" class="px-4 py-2 border rounded">Cancel</button>
      <button id="btn_cta_create_folder" class="px-4 py-2 bg-blue-500 text-white rounded">OK</button>
    </div>

    <!-- close icon -->
    <button id="closeX" class="absolute top-2 right-5 text-gray-400 hover:text-red-500">‚úï</button>
  </div>
</div>

<!-- ==========SCRIPT HERE ===============-->
<script>
    // global scope
    const imageContainerElement = document.querySelector('#image_container');
    let activeFolderId = "all";
    // modal
    const modal = document.getElementById("modal")

document.getElementById("openModal").onclick = () => {
  modal.classList.remove("hidden")
  modal.classList.add("flex")
}

function closeModal(){
  modal.classList.add("hidden")
  modal.classList.remove("flex")
}

document.getElementById("closeModal").onclick = closeModal
document.getElementById("closeX").onclick = closeModal

// click n·ªÅn ƒë√≥ng
modal.addEventListener("click",(e)=>{
  if(e.target === modal) closeModal()
})
    // lang nghe su kien click btn xoa
    imageContainerElement.addEventListener("click", async (ev) => {
  const deleteBtn = ev.target.closest("button[data-id]");
  if (!deleteBtn) return;

  const imagePath = deleteBtn.dataset.id;

  if (!confirm("Xo√° ·∫£nh n√†y?")) return;

  try {
    const res = await fetch("/admin/gallery/image-delete-ajax", {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        img_path: imagePath,
        folder_id: activeFolderId
      })
    });

    const data = await res.json();
    if (!data.success) return alert("Xo√° l·ªói");

    renderImages(data.images);

  } catch (err) {
    console.log(err);
  }
});

    //
    document.querySelector('#btn_cta_create_folder').addEventListener('click', (ev)=>{
        const payload = {folder_name: document.querySelector('input[name="foler_name"]').value}
        //
        console.log(payload)
        fetch(`/admin/gallery/category/create`,
            {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload),
            }
        ).then(res=>res.json())
        .then(res=>{console.log(res); if(res.success){alert('created success'); document.location.reload();}})
        .catch(err=>{console.log('loi tao thu muc'); alert('created folder failed')})
    });
    //folder ajax
    const folderTree = document.querySelector("#folder_tree");

folderTree.addEventListener("click", async (e) => {
  const folderItem = e.target.closest(".folder-item");
  if (!folderItem) return;

  const folderId = folderItem.dataset.folder;
  activeFolderId = folderId; // ‚≠ê l∆∞u folder ƒëang ch·ªçn

  document.querySelectorAll(".folder-item").forEach(el =>
    el.classList.remove("bg-indigo-50","text-indigo-700","font-semibold")
  );
  folderItem.classList.add("bg-indigo-50","text-indigo-700","font-semibold");

  const res = await fetch(`/admin/gallery/images?folder=${folderId}`);
  const data = await res.json();
  renderImages(data.images);
});

//btn upload ·∫£nh
document.getElementById("btnUpload").addEventListener("click", async () => {
  const fileInput = document.getElementById("uploadInput");
  const file = fileInput.files[0];

  if (!file) return alert("Ch·ªçn ·∫£nh");

  const formData = new FormData();
  formData.append("image", file);
  formData.append("folder_id", activeFolderId);

  try {
    const res = await fetch("/admin/gallery/image-upload-ajax", {
      method: "POST",
      body: formData
    });

    const data = await res.json();

    if (!data.success) return alert("Upload l·ªói");

    renderImages(data.images); // render l·∫°i ·∫£nh
    fileInput.value = "";

  } catch (err) {
    console.log(err);
  }
});

//
function renderImages(images) {
  imageContainerElement.innerHTML = "";

  if (!images.length) {
    imageContainerElement.innerHTML = `
      <p class="col-span-full text-center text-gray-500">
        Ch∆∞a c√≥ ·∫£nh n√†o
      </p>
    `;
    return;
  }

  images.forEach(img => {
    const html = `
      <div class="group relative rounded-xl overflow-hidden shadow bg-white">
        <img src="/${img.path}"
        loading="lazy"
          class="w-full h-40 object-cover transition group-hover:scale-105"/>

        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100
          flex items-center justify-center gap-3 transition">

          <a href="/${img.path}" target="_blank"
            class="px-3 py-1.5 bg-white rounded-lg text-sm">View</a>

          <button data-id="${img.path}"
            class="px-3 py-1.5 bg-red-500 text-white rounded-lg text-sm">
            Delete
          </button>
        </div>
      </div>
    `;

    imageContainerElement.insertAdjacentHTML("beforeend", html);
  });
}
//xoa folder
folderTree.addEventListener("click", async (e) => {

  // CLICK XO√Å FOLDER
  const delBtn = e.target.closest("[data-del]");
  if (delBtn) {
    const folderId = delBtn.dataset.del;

    if (!confirm("Xo√° folder v√† to√†n b·ªô ·∫£nh b√™n trong?")) return;

    try {
      const res = await fetch("/admin/gallery/folder-delete", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ folder_id: folderId })
      });

      const data = await res.json();
      if (!data.success) return alert("Xo√° l·ªói");

      // reset v·ªÅ all
      activeFolderId = "all";

      // reload folder tree
      location.reload();

    } catch (err) {
      console.log(err);
    }

    return;
  }

  // CLICK SELECT FOLDER
  const folderItem = e.target.closest(".folder-item");
  if (!folderItem) return;

  const folderId = folderItem.dataset.folder;
  activeFolderId = folderId;

  document.querySelectorAll(".folder-item").forEach(el =>
    el.classList.remove("bg-indigo-50","text-indigo-700","font-semibold")
  );
  folderItem.classList.add("bg-indigo-50","text-indigo-700","font-semibold");

  const res = await fetch(`/admin/gallery/images?folder=${folderId}`);
  const data = await res.json();
  renderImages(data.images);
});



</script>