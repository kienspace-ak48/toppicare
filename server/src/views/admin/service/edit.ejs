<div class="max-w-2xl mx-auto p-6 bg-white rounded shadow">
  <h1 class="text-xl font-semibold mb-6">Chỉnh sửa dịch vụ</h1>

  <form id="serviceForm" class="space-y-4">
    <div>
      <label class="block mb-1 font-medium">Chọn image</label>
      <!-- image handle action -->
        <div class="image_action">
          <div class="flex justify-between items-center  mt-3">
            <button class="w-full px-4 py-3  chooseImg rounded-lg border border-green-500">Choose image</button>
            <input
              type="text"
              id="thumbnail"
              name="thumbnail"
              value="<%=(service && service.thumbnail)?service.thumbnail:''%>"
              class="flex-3 img_input w-full px-4 py-3 border border-gray-300 rounded-lg hidden"
              placeholder="img"
            />
          </div>
          <div class="img_preview border border-gray-300 w-full h-[200px]">
            <img src="/<%=(service && service.thumbnail)?service.thumbnail:''%>" alt="" class="w-full object-cover max-h-[200px]">
          </div>
        </div>
        <!--  -->
    </div>
    <div>
      <label class="block mb-1 font-medium">Tên dịch vụ</label>
      <input name="name" value="<%= service.name %>"
        class="w-full border rounded px-3 py-2" />
    </div>

    <div>
      <label class="block mb-1 font-medium">Mô tả ngắn</label>
      <textarea name="shortDesc" rows="2"
        class="w-full border rounded px-3 py-2"><%= service.shortDesc %></textarea>
    </div>

    <div>
      <label class="block mb-1 font-medium">Mô tả chi tiết</label>
      <textarea name="description" rows="4"
        class="w-full border rounded px-3 py-2"><%= service.desc%></textarea>
    </div>

    <div>
      <label class="block mb-1 font-medium">Lợi ích</label>
      <textarea name="benefits" rows="4"
        class="w-full border rounded px-3 py-2"><%= service.benefits?.join("\n") %></textarea>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block mb-1 font-medium">Nổi bật</label>
        <select name="isFeatured" class="w-full border rounded px-3 py-2">
          <option value="1" <%= service.isFeatured ? "selected" : "" %>>Có</option>
          <option value="0" <%= !service.isFeatured ? "selected" : "" %>>Không</option>
        </select>
      </div>

      <div>
        <label class="block mb-1 font-medium">Trạng thái</label>
        <select name="status" class="w-full border rounded px-3 py-2">
          <option value="1" <%= service.status ? "selected" : "" %>>Hiển thị</option>
          <option value="0" <%= !service.status ? "selected" : "" %>>Ẩn</option>
        </select>
      </div>
    </div>

    <div class="flex justify-end gap-2">
      <button type="button" onclick="history.back()"
        class="px-4 py-2 border rounded">
        Quay lại
      </button>
      <button type="submit"
        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
        Cập nhật
      </button>
    </div>
  </form>
</div>
<!-- =================MODAL===================== -->
<div
  id="gallery_modal"
  class="fixed inset-0 bg-black/50 items-center hidden justify-center z-40"
>
  <div class="bg-white min-w-75 max-h-[80vh] rounded p-4 overflow-y-auto">
    <div class="header flex justify-between mb-4">
      <h2>Chon anh</h2>
      <button type="button" onclick="closeChooseImgModal()">X</button>
    </div>
    <!--  -->
    <div id="imgList" class="grid grid-cols-4 gap-4"></div>
  </div>
</div>
<!-- ==============SCRIPT HERE ===================== -->
<script>
document.getElementById("serviceForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const data = Object.fromEntries(new FormData(e.target));
  data.benefits = data.benefits
    ? data.benefits.split("\n").filter(i => i.trim())
    : [];

  const res = await fetch("/admin/service/update/<%= service._id %>", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  const result = await res.json();
  if(result.success){
    alert("Cập nhật thành công");
    history.back();
  } else {
    alert("Có lỗi xảy ra");
  }
});
//choose image 
//
  const chooseImgModal = document.querySelector("#gallery_modal");
  var ctaChooseImg = document.querySelectorAll(".chooseImg");
  let imgInputIsFocusing = null;

    function openChooseImgModal() {
    chooseImgModal.classList.remove("hidden");
    chooseImgModal.classList.add("flex");
  }
  function closeChooseImgModal() {
    chooseImgModal.classList.remove("flex");
    chooseImgModal.classList.add("hidden");
  }
  ctaChooseImg.forEach((el) => {
    el.addEventListener("click", (ev) => {
      console.log(el);
      ev.preventDefault();
      loadImage();
      let input = el.closest('.image_action');
      imgInputIsFocusing = input;
      console.log("input ", input);
      openChooseImgModal();
    });
  });
  //
  function loadImage() {
    imgList.innerHTML = "Loading...";
    $.ajax({
      url: "/admin/gallery/image-getall",
      method: "GET",
      success: (res) => {
        if (res.success) {
          imgList.innerHTML = "";
          res.data.forEach((item) => {
            const img = document.createElement("img");
            img.src = "/" + item.path;
            img.className = `
            w-full h-32
            object-cover
            cursor-pointer rounded border
            hover:ring-4 hover:ring-blue-500
            transition
          `;

            img.onclick = () => selectImage(item.path);

            imgList.appendChild(img);
          });
        }
      },
      error: (xhr, status, err) =>
        console.log(xhr.responseJSON?.mess || "Server error"),
    });
  }
  //
  function selectImage(src) {
    imgInputIsFocusing.querySelector('.img_input').value = src;
     imgInputIsFocusing.querySelector('.img_preview img').src ="/"+src;
    closeChooseImgModal();
  }
  // 
</script>
